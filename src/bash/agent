#!/bin/bash

function getgpgkey () {
    keyVal=$(gpg -K |
          awk '/sec/{if (length($2) > 0) print $2}' |
          sed 's|.*/0x||' )
    echo -ne ${keyVal}
}

function getsshkey () {
    cd ${HOME}/.ssh/ &&
    SSHKEYS=$(ls *.pub |
                  cut -d. -f1 |
                  cut -d- -f1 |
                  cut -d_ -f2 |
                  sort -u) &&
    echo ${SSHKEYS}
    for key in ${SSHKEYS}
    do
        [[ "${key}" == "gpg"]] &&
            user=$(echo ${HOME}| sed 's|.*/||') &&
            key=${user}_${key}
        [[ -f .ssh/$key ]] &&
            KEYS="${KEYS} ${key}" &&
            [[ "${key}" == "id_dsa" ]] &&
            echo "Warning you are still using dsa"
    done
    echo -ne ${KEYS}

}

function start_agents () {
    unset KEYS
    if [[ -n "$DESKTOP_SESSION" ]]; then
        eval $(gnome-keyring-daemon --start)
        export SSH_AUTH_SOCK
    else
        # SSH Agent
        if command -v keychain 2&> /dev/null; then
            # ID GPG Keys
            keyVal=$(getgpgkey) &&
                [[ -n ${keyVal} ]] &&
                KEYS="${KEYS} ${keyVal}" &&
                eval "$(keychain --eval --agents gpg ${KEYS})"

            # Clear KEYS
            unset KEYS &&
                # ID SSH Keys
                SSHKEYS=$(getsshkey) &&
                [[ -n ${SSHKEYS} ]] &&
                KEYS="${KEYS} ${SSHKEYS}" &&
                eval "$(keychain --eval --agents ssh ${KEYS})"
        fi
    fi
}

start_agents
